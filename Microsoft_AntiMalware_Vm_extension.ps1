# Script to add Microsoft Antimalware extension to the Virtual Machines

$subscriptionId = "341d16e4-6b63-4c11-b421-559c8d724348"  #Subscription ID

$location = "eastus2"   # Location 

$resourceGroupName = "newrg"    # Resource group name of the VM 

$vmName = "vmtest"    # Name of the virtual Machine

#$settingString = ‘{"AntimalwareEnabled": true}’;

#########Login to your Azure Resource Manager Account and select the Subscription to use

#Login-AzureRmAccount
Select-AzSubscription -Subscription $subscriptionId

# retrieve the most recent version number of the extension 

$allVersions= (Get-AzVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” `
-Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]

# set the extension using prepared values

$vm = Get-AzVM -ResourceGroupName $resourceGroupName -Name $vmName

$vmName = $vm.Name
$resourceGroupName = $vm.ResourceGroupName
$location = $vm.Location

Write-Host " Enabling the Antimalware Solution for $vmName " -ForegroundColor Green

$response = Set-AzVMExtension -ResourceGroupName $resourceGroupName -Location $location -VMName $vmName `
-Name "IaaSAntimalware" -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” `
-TypeHandlerVersion $versionString #-SettingString $settingString

if($response.IsSuccessStatusCode -eq $true)
{
Write-Host "Microsoft IAAS Anti-Malware Vm extension enabled" -ForegroundColor Green
}
